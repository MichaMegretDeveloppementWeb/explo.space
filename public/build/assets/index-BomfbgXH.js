import{L as r,g as n}from"./map-responsive-config-DdMpAmdA.js";import{c as d}from"./marker-icon-utils-Ct1xqS19.js";import{R as p}from"./recaptcha-service-C60lUiXK.js";class c{constructor(e="placeRequestMap"){this.containerId=e,this.map=null,this.marker=null,this.init()}init(){const e=document.getElementById(this.containerId);return e?(this.createMap(e),this.setupListeners(),!0):(console.warn(`PlaceRequestMap: Container #${this.containerId} not found`),!1)}createMap(e){const i=[48.8566,2.3522],t=4;this.map=r.map(e,{center:i,zoom:t,maxBounds:[[-90,-180],[90,180]],maxBoundsViscosity:1}),this.addTileLayer(),this.map.on("click",a=>this.handleMapClick(a))}addTileLayer(){const e=r.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',subdomains:["a","b","c","d"],maxZoom:19,minZoom:n()});e.on("tileerror",()=>{console.warn("CartoDB tiles failed, switching to OSM fallback"),this.map.removeLayer(e),r.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19,minZoom:n()}).addTo(this.map)}),e.addTo(this.map)}handleMapClick(e){const i=e.latlng.lat,t=e.latlng.lng;this.setMarker(i,t),window.dispatchEvent(new CustomEvent("map-geocoding-started")),window.Livewire&&window.Livewire.dispatch("map-clicked",{latitude:i,longitude:t})}setMarker(e,i){this.marker&&this.map.removeLayer(this.marker),this.marker=r.marker([e,i],{icon:d(),draggable:!0}).addTo(this.map),this.marker.on("dragend",t=>{const a=t.target.getLatLng();window.dispatchEvent(new CustomEvent("map-geocoding-started")),window.Livewire&&window.Livewire.dispatch("map-clicked",{latitude:a.lat,longitude:a.lng})})}centerOnLocation(e,i){this.map&&(this.setMarker(e,i),this.map.setView([e,i],13))}setupListeners(){const e=()=>{window.Livewire.on("address-selected",i=>{const t=Array.isArray(i)?i[0]:i;t&&t.latitude&&t.longitude&&(this.setMarker(t.latitude,t.longitude),this.map.setView([t.latitude,t.longitude],13))}),window.Livewire.on("coordinates-changed",i=>{const t=Array.isArray(i)?i[0]:i;t&&t.latitude&&t.longitude&&(this.setMarker(t.latitude,t.longitude),this.map.setView([t.latitude,t.longitude],this.map.getZoom()))})};window.Livewire?e():document.addEventListener("livewire:init",e)}destroy(){this.map&&(this.map.remove(),this.map=null)}}function h(){return{async handleSubmit(){try{if(!window.recaptcha||typeof window.recaptcha.getToken!="function"){this.$wire.call("submit");return}const o=await window.recaptcha.getToken("place_request_submit");this.$wire.call("submit",o)}catch(o){console.error("❌ reCAPTCHA error in Alpine:",o),this.$wire.call("handleRecaptchaError",o.message)}}}}class u{constructor(e="#photo-drop-zone",i="#photos"){this.dropZone=null,this.fileInput=null,this.dropZoneSelector=e,this.inputSelector=i,this.maxFileSize=10*1024*1024,this.maxFiles=10,this.allowedTypes=["image/jpeg","image/jpg","image/png","image/webp"],this.init()}init(){if(this.dropZone=document.querySelector(this.dropZoneSelector),this.fileInput=document.querySelector(this.inputSelector),!this.dropZone||!this.fileInput){console.warn("PhotoUploader: Drop zone or file input not found");return}this.setupEventListeners(),this.addStyles()}setupEventListeners(){["dragenter","dragover","dragleave","drop"].forEach(e=>{document.addEventListener(e,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(e=>{this.dropZone.addEventListener(e,()=>this.highlight(),!1)}),["dragleave","drop"].forEach(e=>{this.dropZone.addEventListener(e,()=>this.unhighlight(),!1)}),this.dropZone.addEventListener("drop",e=>this.handleDrop(e),!1)}preventDefaults(e){e.preventDefault(),e.stopPropagation()}highlight(){this.dropZone.classList.add("drop-zone-active")}unhighlight(){this.dropZone.classList.remove("drop-zone-active")}handleDrop(e){const t=e.dataTransfer.files;this.handleFiles(t)}handleFiles(e){const i=Array.from(e),t=this.validateFiles(i);if(!t.valid){alert(t.error);return}const a=new DataTransfer;t.validFiles.forEach(l=>{a.items.add(l)}),this.fileInput.files=a.files,this.fileInput.dispatchEvent(new Event("input",{bubbles:!0})),this.fileInput.dispatchEvent(new Event("change",{bubbles:!0})),console.log(`PhotoUploader: ${t.validFiles.length} file(s) selected via drag & drop`)}validateFiles(e){const i=[],t=[];if(e.length>this.maxFiles)return{valid:!1,error:`Vous ne pouvez télécharger que ${this.maxFiles} photos maximum.`};for(const a of e)i.push(a);return t.length>0?{valid:!1,error:`Fichiers invalides :
${t.join(`
`)}`}:{valid:!0,validFiles:i}}addStyles(){if(document.getElementById("photo-uploader-styles"))return;const e=document.createElement("style");e.id="photo-uploader-styles",e.textContent=`
            .drop-zone-active {
                border-color: #3b82f6 !important;
                background-color: #eff6ff !important;
            }

            .drop-zone-active svg {
                color: #3b82f6 !important;
            }
        `,document.head.appendChild(e)}destroy(){this.dropZone&&["dragenter","dragover","dragleave","drop"].forEach(e=>{this.dropZone.removeEventListener(e,this.preventDefaults)})}}const s=()=>{window.Alpine&&typeof window.Alpine.data=="function"?window.Alpine.data("placeRequestForm",h):console.warn("⚠️ Alpine.data not available")};window.Alpine?s():document.addEventListener("alpine:init",s);document.addEventListener("DOMContentLoaded",()=>{document.getElementById("placeRequestMap")&&new m});class m{constructor(){this.map=null,this.recaptcha=null,this.photoUploader=null,this.init()}init(){this.initializeMap(),this.initializeRecaptcha(),this.initializePhotoUploader()}initializeMap(){this.map=new c("placeRequestMap"),this.map.map||console.warn("⚠️ Failed to initialize map")}initializeRecaptcha(){this.recaptcha=p,this.recaptcha.init()?console.log("✅ reCAPTCHA initialized for PlaceRequest"):console.warn("⚠️ Failed to initialize reCAPTCHA")}initializePhotoUploader(){try{this.photoUploader=new u("#photo-drop-zone","#pendingPhotos")}catch(e){console.error("✗ PhotoUploader failed:",e)}}}
